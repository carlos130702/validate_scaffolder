   <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>🚀 Validador de Repositorios Scaffolder</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            
            .container {
                max-width: 1000px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                overflow: hidden;
            }
            
            .header {
                background: #2c3e50;
                color: white;
                padding: 30px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1.2em;
                opacity: 0.9;
            }
            
            .form-section {
                padding: 30px;
            }
            
            .form-group {
                margin-bottom: 25px;
            }
            
            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 14px;
            }
            
            input, textarea {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.3s ease;
            }
            
            input:focus, textarea:focus {
                border-color: #4285f4;
                outline: none;
                box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
            }
            
            .button-group {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                margin-top: 30px;
            }
            
            button {
                background: #4285f4;
                color: white;
                padding: 15px 30px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            button:hover {
                background: #3367d6;
                transform: translateY(-2px);
            }
            
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }
            
            .btn-secondary {
                background: #6c757d;
            }
            
            .btn-secondary:hover {
                background: #545b62;
            }
            
            .loading {
                display: none;
                text-align: center;
                padding: 40px;
                background: #f8f9fa;
                border-radius: 10px;
                margin: 20px 0;
            }
            
            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #4285f4;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .resultado {
                display: none;
                margin-top: 30px;
                padding: 0;
                border-radius: 10px;
                border: 1px solid #e9ecef;
            }
            
            .result-header {
                background: #28a745;
                color: white;
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .result-content {
                padding: 25px;
                max-height: 600px;
                overflow-y: auto;
            }
            
            .section {
                margin-bottom: 25px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #4285f4;
            }
            
            .section h3 {
                color: #2c3e50;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .metric-card {
                background: white;
                padding: 15px;
                margin: 10px 0;
                border-radius: 6px;
                border: 1px solid #e9ecef;
            }
            
            .estado-ok { color: #28a745; font-weight: bold; }
            .estado-error { color: #dc3545; font-weight: bold; }
            .estado-warning { color: #ffc107; font-weight: bold; }
            
            .help-text {
                font-size: 12px;
                color: #6c757d;
                margin-top: 5px;
                font-style: italic;
            }
            
            .required {
                color: #dc3545;
            }
            
            @media (max-width: 768px) {
                .container {
                    margin: 10px;
                }
                
                .header h1 {
                    font-size: 2em;
                }
                
                .button-group {
                    flex-direction: column;
                }
                
                button {
                    width: 100%;
                }
            }
            .list-card {
                background: #f8f9fa !important;
                border-left: 4px solid #007bff !important;
            }

            .list-content {
                font-family: 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.4;
                margin-top: 10px;
                padding: 15px;
                background: white;
                border-radius: 8px;
                border: 1px solid #e9ecef;
                max-height: 400px;
                overflow-y: auto;
                white-space: pre-wrap;
            }

            .list-file {
                font-weight: bold;
                color: #2c3e50;
                margin: 10px 0 5px 0;
                padding-bottom: 5px;
                border-bottom: 2px solid #dee2e6;
                background: #e9f7fe;
                padding: 8px 12px;
                border-radius: 4px;
            }

            .list-header {
                font-weight: bold;
                color: #28a745;
                margin: 8px 0 4px 0;
                padding: 5px 0;
            }

            .list-item {
                padding: 3px 0 3px 20px;
                margin: 2px 0;
                border-left: 3px solid #6c757d;
            }

            .list-bullet {
                padding: 3px 0 3px 15px;
                margin: 2px 0;
                color: #dc3545;
            }

            .list-line {
                padding: 2px 0;
                margin: 1px 0;
                color: #6c757d;
            }

            /* Mejorar la visualización de las tarjetas */
            .metric-card {
                margin-bottom: 15px;
                padding: 15px;
                background: white;
                border-radius: 8px;
                border: 1px solid #e9ecef;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .metric-card strong {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-size: 14px;
            }

            .estado-ok { color: #28a745; font-weight: bold; }
            .estado-error { color: #dc3545; font-weight: bold; }
            .estado-warning { color: #ffc107; font-weight: bold; }

            .log-output {
                display: block; 
                margin-top: 10px;
                padding: 10px;
                background: #ffffff;
                border: 1px solid #e9ecef;
                border-radius: 4px;
                font-family: 'Courier New', monospace; 
                font-size: 13px;
                white-space: pre-wrap;
            }

            .comentado-card {
                background: #f8f9fa !important;
                border-left: 4px solid #ffc107 !important;
            }

            .comentado-content {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 14px;
                line-height: 1.5;
                margin-top: 10px;
                padding: 15px;
                background: white;
                border-radius: 8px;
                border: 1px solid #e9ecef;
            }

            .comentado-ok {
                color: #28a745;
                font-weight: 500;
                margin: 5px 0;
                padding: 3px 0;
            }

            .comentado-warning {
                color: #fd7e14;
                font-weight: 600;
                margin: 8px 0 5px 0;
                padding: 5px 0;
                border-bottom: 1px solid #dee2e6;
            }

            .comentado-file {
                color: #2c3e50;
                font-weight: 500;
                margin: 8px 0 3px 0;
                padding-left: 10px;
                border-left: 3px solid #6f42c1;
            }

            .comentado-separator {
                text-align: center;
                color: #6c757d;
                margin: 10px 0;
                font-weight: bold;
            }

            .version-card {
                background: #f8f9fa !important;
                border-left: 4px solid #17a2b8 !important;
            }

            .version-content {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 14px;
                line-height: 1.5;
                margin-top: 10px;
                padding: 15px;
                background: white;
                border-radius: 8px;
                border: 1px solid #e9ecef;
            }

            .version-success {
                color: #28a745;
                font-weight: 600;
                margin: 5px 0;
                padding: 5px 0;
            }

            .version-error {
                color: #dc3545;
                font-weight: 600;
                margin: 5px 0;
                padding: 5px 0;
            }

            .version-header {
                color: #2c3e50;
                font-weight: 600;
                margin: 10px 0 5px 0;
                padding: 5px 0;
                border-bottom: 2px solid #dee2e6;
            }

            .version-info {
                color: #6c757d;
                margin: 3px 0;
                padding-left: 15px;
            }

            .version-separator {
                text-align: center;
                color: #6c757d;
                margin: 10px 0;
                font-weight: bold;
            }

            .log-output.estado-ok { color: #28a745; }
            .log-output.estado-error { color: #dc3545; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>🚀 Validador de Repositorios Scaffolder</h1>
            </div>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="url">URL del Repositorio Bitbucket <span class="required">*</span></label>
                    <input type="url" id="url" placeholder="https://bitbucket.globaldevtools.bbva.com/bitbucket/projects/..." required>
                    <div class="help-text">URL completa del repositorio de Bitbucket</div>
                </div>
                
                <div class="form-group">
                    <label for="rama">Rama a analizar <span class="required">*</span></label>
                    <input type="text" id="rama" placeholder="develop" value="develop" required>
                    <div class="help-text">Nombre de la rama que deseas analizar</div>
                </div>
                
                <div class="form-group">
                    <label for="token">Token de Bitbucket</label>
                    <input type="password" id="token" placeholder="Ingresa tu token si es necesario">
                </div>

                <div class="button-group">
                    <button onclick="analizar()" id="btnAnalizar">
                        <span>🔍</span> Ejecutar Análisis
                    </button>
                    <button onclick="limpiar()" class="btn-secondary">
                        <span>🔄</span> Limpiar
                    </button>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <h3>⏳ Analizando repositorio...</h3>
                <p>Esto puede tomar unos momentos mientras revisamos todos los archivos</p>
            </div>

            <div id="resultado" class="resultado">
                <!-- Los resultados se cargan aquí dinámicamente -->
            </div>
        </div>

        <script>
            function analizar() {
                const url = document.getElementById('url').value.trim();
                const rama = document.getElementById('rama').value.trim();
                const token = document.getElementById('token').value.trim();
                
                if (!url) {
                    alert('❌ Por favor ingresa una URL válida');
                    return;
                }
                
                if (!rama) {
                    alert('❌ Por favor ingresa el nombre de la rama');
                    return;
                }
                
                // Mostrar loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('resultado').style.display = 'none';
                document.getElementById('btnAnalizar').disabled = true;
                
                // Enviar petición
                fetch('/analizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: url,
                        rama: rama,
                        token: token
                    })
                })
                .then(response => response.json())
                .then(data => {
                    mostrarResultado(data);
                })
                .catch(error => {
                    mostrarError(error);
                })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('btnAnalizar').disabled = false;
                });
            }
            
            function mostrarResultado(data) {
                const resultadoDiv = document.getElementById('resultado');
                
                if (data.success) {
                    let html = `
                        <div class="result-header">
                            <h2><span>✅</span> Análisis Completado</h2>
                            <span>${new Date().toLocaleString()}</span>
                        </div>
                        <div class="result-content">    
                    `;
                    
                    if (data.data && data.columns) {
                        html += '<div class="section"><h3>📊 Resultados del Análisis</h3>';
                        
                        data.columns.forEach((columna, index) => {
                            if (data.data[columna] && data.data[columna][0]) {
                                let valor = data.data[columna][0];
                                const estado = getEstadoFromValor(valor);
                                
                                // 🎯 CAMPOS QUE NECESITAN FORMATEO ESPECIAL
                                const camposEspeciales = {
                                    "Codigo Comentado Inválido (###)": "comentado",
                                    "Resultado de validación de versiones": "versiones",
                                    "Nombre de función incorrecta": "lista",
                                    "Field y Fields Incorrectos": "lista",
                                    "Nombre de campo/variable incorrectos": "lista"
                                };
                                
                                const tipoFormato = camposEspeciales[columna];
                                
                                if (tipoFormato === "comentado") {
                                    html += crearTarjetaComentado(columna, valor, estado);
                                } else if (tipoFormato === "versiones") {
                                    html += crearTarjetaVersiones(columna, valor, estado);
                                } else if (tipoFormato === "lista") {
                                    html += crearTarjetaLista(columna, valor, estado);
                                } else {
                                    html += `
                                        <div class="metric-card">
                                            <strong>${columna}:</strong>
                                            <span class="${estado.clase}">${valor}</span>
                                        </div>
                                    `;
                                }
                            }
                        });
                        
                        html += '</div>';
                    }
                    
                    html += `</div></div>`;
                    resultadoDiv.innerHTML = html;
                } else {
                    mostrarError(data.error);
                }
                
                resultadoDiv.style.display = 'block';
            }

            function crearTarjetaComentado(columna, valor, estado) {
                const lineas = String(valor).split('\n');
                let contenido = '';
                
                lineas.forEach(linea => {
                    linea = linea.trim();
                    if (!linea) return;
                    
                    // Aplicar formato basado en el contenido del texto
                    if (linea.includes('Comentarios invalidos')) {
                        contenido += `<div class="comentado-warning">🚨 ${linea}</div>`;
                    } else if (linea.endsWith('- ok')) {
                        const archivo = linea.replace(' - ok', '');
                        contenido += `<div class="comentado-ok">✅ ${archivo} - Correcto</div>`;
                    } else if (linea.includes('---')) {
                        contenido += `<div class="comentado-separator">${'─'.repeat(40)}</div>`;
                    } else if (linea.match(/^\d+\./)) {
                        contenido += `<div class="comentado-line">   ${linea}</div>`;
                    } else {
                        contenido += `<div class="comentado-file">📄 ${linea}</div>`;
                    }
                });
                
                return `
                    <div class="metric-card comentado-card">
                        <strong>${columna}:</strong>
                        <div class="comentado-content ${estado.clase}">
                            ${contenido || '<div class="comentado-ok">✅ No se encontraron problemas</div>'}
                        </div>
                    </div>
                `;
            }

            function crearTarjetaVersiones(columna, valor, estado) {
                const lineas = String(valor).split('\n');
                let contenido = '';
                
                // Detectar si las versiones son iguales
                const esConsistente = valor.toLowerCase().includes('iguales');
                
                if (esConsistente) {
                    contenido += `<div class="version-success">✅ VERSIONES CONSISTENTES</div>`;
                    contenido += `<div class="version-header">📊 Todas las versiones coinciden:</div>`;
                } else {
                    contenido += `<div class="version-error">❌ VERSIONES INCONSISTENTES</div>`;
                    contenido += `<div class="version-header">⚠️ Se detectaron diferencias:</div>`;
                }
                
                // Extraer versión de referencia (setup.cfg)
                let versionReferencia = '';
                lineas.forEach(linea => {
                    if (linea.includes('setup.cfg:')) {
                        const partes = linea.split(':');
                        if (partes.length > 1) {
                            versionReferencia = partes[1].trim();
                        }
                    }
                });
                
                lineas.forEach(linea => {
                    linea = linea.trim();
                    if (!linea) return;
                    
                    if (linea.includes('setup.cfg:')) {
                        const partes = linea.split(':');
                        if (partes.length > 1) {
                            const archivo = partes[0].replace('-', '').replace('**', '').trim();
                            const version = partes[1].trim();
                            contenido += `<div class="version-reference">🎯 ${archivo}: ${version} ${esConsistente ? '← CORRECTO' : '← REFERENCIA'}</div>`;
                        }
                    } else if (linea.includes('setup.py:') || linea.includes('__init__.py:') || linea.includes('Kaafile:')) {
                        const partes = linea.split(':');
                        if (partes.length > 1) {
                            const archivo = partes[0].replace('-', '').replace('**', '').trim();
                            const version = partes[1].trim();
                            
                            if (esConsistente) {
                                contenido += `<div class="version-success">✅ ${archivo}: ${version} ← CORRECTO</div>`;
                            } else if (versionReferencia && version === versionReferencia) {
                                contenido += `<div class="version-success">✅ ${archivo}: ${version} ← COINCIDE</div>`;
                            } else if (versionReferencia) {
                                contenido += `<div class="version-error">❌ ${archivo}: ${version} ← DEBERÍA SER: ${versionReferencia}</div>`;
                            } else {
                                contenido += `<div class="version-line">📄 ${archivo}: ${version}</div>`;
                            }
                        }
                    } else if (linea.includes('---')) {
                        contenido += `<div class="version-separator">${'─'.repeat(40)}</div>`;
                    } else if (!linea.includes('Vesiones iguales')) {
                        contenido += `<div class="version-info">ℹ️ ${linea}</div>`;
                    }
                });
                
                return `
                    <div class="metric-card version-card">
                        <strong>${columna}:</strong>
                        <div class="version-content ${estado.clase}">
                            ${contenido}
                        </div>
                    </div>
                `;
            }

            function crearTarjetaLista(columna, valor, estado) {
                return `
                    <div class="metric-card list-card">
                        <strong>${columna}:</strong>
                        <div class="list-content ${estado.clase}">${formatearLista(valor)}</div>
                    </div>
                `;
            }

            // 🆕 FUNCIÓN PARA FORMATEAR LISTAS
            function formatearLista(texto) {
                if (!texto) return '';
                
                let html = '';
                const lineas = String(texto).split('\n');
                
                lineas.forEach(linea => {
                    linea = linea.trim();
                    if (!linea) return;
                    
                    // Detectar archivos (.py:)
                    if (linea.includes('.py:') || (linea.endsWith(':') && !linea.includes('•'))) {
                        html += `<div class="list-file">📁 ${linea}</div>`;
                    }
                    // Detectar líneas numeradas (1., 2., etc.)
                    else if (linea.match(/^\s*\d+\./)) {
                        html += `<div class="list-item">${linea}</div>`;
                    }
                    // Detectar bullets (•)
                    else if (linea.includes('•')) {
                        html += `<div class="list-bullet">${linea}</div>`;
                    }
                    // Detectar encabezados de sección
                    else if (linea.includes('Se encontraron') || linea.includes('errores') || linea.includes('encontraron')) {
                        html += `<div class="list-header">${linea}</div>`;
                    }
                    // Líneas normales
                    else {
                        html += `<div class="list-line">${linea}</div>`;
                    }
                });
                
                return html;
            }
            
            function mostrarError(error) {
                const resultadoDiv = document.getElementById('resultado');
                const errorMsg = typeof error === 'string' ? error : error.message || 'Error desconocido';
                
                resultadoDiv.innerHTML = `
                    <div class="result-header" style="background: #dc3545;">
                        <h2><span>❌</span> Error en el Análisis</h2>
                    </div>
                    <div class="result-content">
                        <div class="section">
                            <h3>⚠️ Detalles del Error</h3>
                            <div class="metric-card">
                                <strong>Error:</strong>
                                <span class="estado-error">${errorMsg}</span>
                            </div>
                            <p>Verifica que la URL sea correcta y que tengas acceso al repositorio.</p>
                        </div>
                    </div>
                `;
                resultadoDiv.style.display = 'block';
            }
            
            function limpiar() {
                document.getElementById('url').value = '';
                document.getElementById('rama').value = 'develop';
                document.getElementById('token').value = '';
                document.getElementById('resultado').style.display = 'none';
                document.getElementById('resultado').innerHTML = '';
            }
            
            function getEstadoFromValor(valor) {
                const texto = String(valor || ""); 
                if (texto.includes('✅') || texto.includes('OK')) {
                    return { clase: 'estado-ok' };
                } else if (texto.includes('❌') || texto.includes('ERROR')) {
                    return { clase: 'estado-error' };
                } else if (texto.includes('⚠️') || texto.includes('WARNING')) {
                    return { clase: 'estado-warning' };
                }
                return { clase: '' };
            }
            
            document.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    analizar();
                }
            });
        </script>
    </body>
    </html>

